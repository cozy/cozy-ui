language: node_js
dist: jammy
node_js:
  - 16
cache:
  yarn: true
  directories:
    - node_modules
env:
  global:
    - PR_TITLE=$(curl https://github.com/${TRAVIS_REPO_SLUG}/pull/${TRAVIS_PULL_REQUEST} 2> /dev/null | grep "title" | head -1)
    - BUILD_TEMP_FILENAME=cozy-ui-tempbuild-${TRAVIS_BUILD_ID}.tar.gz
stages:
  - prebuild
  - build
  - postbuild
  - deploy
jobs:
  include:
    - name: 'Lint'
      stage: 'prebuild'
      script: yarn lint
    - name: 'Sprite and Palette'
      stage: 'prebuild'
      script: yarn makeSpriteAndPalette
      workspaces:
        create:
          name: sprite-palette-binaries
          paths:
            - ./react/Icon/icons-sprite.js
            - ./react/palette.js
    - name: 'Build JS'
      stage: 'build'
      script:
        - yarn build
      workspaces:
        use:
          - sprite-palette-binaries
        create:
          name: js-binaries
          paths:
            - ./transpiled
    - name: 'Build CSS'
      stage: 'build'
      script:
        - yarn build:css:all
      workspaces:
        create:
          name: css-binaries
          paths:
            - ./dist
    - name: 'Fetch docs based on Muiv4 and Build Muiv5 docs'
      stage: 'postbuild'
      workspaces:
        use:
          - sprite-palette-binaries
          - js-binaries
          - css-binaries
        create:
          name: docs-binaries
          paths:
            - ./build
      script:
        - mkdir build
        - git-directory-deploy --directory build/ --branch gh-pages --ignore_removal --allow_empty
        - rm -rf ./build/next
        - yarn build:doc:react
        - yarn build:doc:kss
    - name: 'Tests without snapshots'
      stage: 'postbuild'
      workspaces:
        use:
          - sprite-palette-binaries
          - js-binaries
          - css-binaries
      script:
        - yarn test:noSnapshots
    - name: 'Tests snapshots'
      stage: 'postbuild'
      workspaces:
        use:
          - sprite-palette-binaries
          - js-binaries
          - css-binaries
      script:
        - yarn test:snapshots
    - name: 'Argos'
      stage: 'postbuild'
      workspaces:
        use:
          - js-binaries
          - css-binaries
      script: |
        if [[ "${PR_TITLE}" != *"[skip argos]"* ]]; then
          mkdir ./screenshots
          yarn screenshots --mode react --viewport desktop --screenshot-dir ./screenshots/reactDesktop
          yarn screenshots --mode react --viewport 300x600 --screenshot-dir ./screenshots/reactMobile
          yarn screenshots --mode kss --screenshot-dir ./screenshots/kss
          yarn argos:upload --parallel screenshots/next/reactDesktop/ --token $ARGOS_TOKEN  --parallel-total 3 --parallel-nonce $TRAVIS_BUILD_ID
          yarn argos:upload --parallel screenshots/next/reactMobile/ --token $ARGOS_TOKEN  --parallel-total 3 --parallel-nonce $TRAVIS_BUILD_ID
          yarn argos:upload --parallel screenshots/next/kss/ --token $ARGOS_TOKEN  --parallel-total 3 --parallel-nonce $TRAVIS_BUILD_ID
        fi
    - name: 'Bundlemon'
      stage: 'postbuild'
      workspaces:
        use:
          - sprite-palette-binaries
          - js-binaries
          - css-binaries
      script:
        - yarn bundlemon
    - name: 'Deploy'
      stage: 'deploy'
      workspaces:
        use:
          - sprite-palette-binaries
          - js-binaries
          - css-binaries
          - docs-binaries
      script: 'true'
      deploy:
        provider: script
        skip-cleanup: true
        script: yarn deploy:doc -- --username cozycloud --email contact@cozycloud.cc --repo https://cozy-bot:$GH_TOKEN@github.com/cozy/cozy-ui.git && yarn semantic-release
        on:
          branch: next
